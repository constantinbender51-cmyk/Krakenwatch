<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primate | Observatory</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'] 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #ffffff; 
            color: #1a1a1a; 
            font-family: 'Inter', sans-serif; 
            
            /* Background Image Setup */
            background-image: url('https://i.postimg.cc/QxYJKvBy/1767741251392.png');
            background-repeat: no-repeat;
            background-position: top center;
            background-size: 100% auto;
            background-attachment: scroll;
        }

        @media (min-width: 768px) {
            body {
                background-size: 600px auto;
            }
        }
        
        /* Clinical Minimalism */
        .page-container { max-width: 1000px; margin: 0 auto; padding: 120px 0 40px 0; }
        
        .content-pad { padding-left: 20px; padding-right: 20px; }
        
        /* Typography */
        h1, h2, h3 { font-weight: 400; letter-spacing: -0.02em; }
        
        /* Brand Styling */
        .brand-text {
            font-weight: 200; 
            font-size: 2.25rem; letter-spacing: 0.4em;
            text-transform: uppercase; color: #1a1a1a;
            opacity: 0; 
        }
        
        /* Minimal Links */
        .clinical-link { 
            color: #1a1a1a; text-decoration: none; border-bottom: 1px solid #e5e5e5; 
            padding-bottom: 2px; transition: all 0.2s; cursor: pointer; font-size: 0.9rem;
        }
        .clinical-link:hover { border-bottom-color: #1a1a1a; }
        
        /* Minimal Table */
        .clean-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .clean-table th { text-align: left; font-weight: 500; color: #888; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
        .clean-table td { padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-family: 'JetBrains Mono', monospace; }
        .clean-table tr:last-child td { border-bottom: none; }

        /* Menu Overlay */
        .menu-overlay {
            position: fixed; top: 0; right: 0; width: 250px; height: 100vh; 
            background: white; border-left: 1px solid #e5e5e5; 
            transform: translateX(100%); transition: transform 0.3s ease; z-index: 100; padding: 40px;
        }
        .menu-overlay.open { transform: translateX(0); }
        .menu-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(2px);
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90;
        }
        .menu-backdrop.open { opacity: 1; pointer-events: auto; }
        
        /* SPA Transitions */
        .view-section { display: none; opacity: 0; transition: opacity 0.15s ease-in-out; }
        .view-section.active { display: block; opacity: 1; }
    </style>
</head>
<body class="antialiased min-h-screen">

    <!-- Header / Logo Click Area -->
    <div class="fixed top-8 left-1/2 transform -translate-x-1/2 z-50 cursor-pointer select-none" onclick="router.navigate('home')">
        <h1 class="brand-text">Primate</h1>
    </div>

    <!-- Burger Menu Icon -->
    <div class="fixed top-8 right-6 z-50 cursor-pointer p-2 hover:bg-gray-50 rounded-full" onclick="toggleMenu()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-black transition"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
    </div>

    <!-- Menu Panel -->
    <div class="menu-backdrop" id="menu-backdrop" onclick="toggleMenu()"></div>
    <div class="menu-overlay" id="menu-panel">
        <div class="flex flex-col space-y-6 mt-12">
            <a onclick="router.navigate('home'); toggleMenu()" class="clinical-link">Home</a>
            <a onclick="router.navigate('balance'); toggleMenu()" class="clinical-link">Balance</a>
            <a onclick="router.navigate('log'); toggleMenu()" class="clinical-link">Log</a>
            <a onclick="router.navigate('contact'); toggleMenu()" class="clinical-link">Contact</a>
        </div>
    </div>

    <div class="page-container">

        <!-- HOME VIEW -->
        <div id="view-home" class="view-section active">
            <div class="mb-12">
                <div class="h-[400px] w-full relative">
                    <canvas id="homeChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 content-pad" id="symbol-links-container">
                <div class="text-center text-gray-300 text-sm col-span-full font-mono">Loading assets...</div>
            </div>
        </div>

        <!-- SYMBOL DETAIL VIEW -->
        <div id="view-symbol" class="view-section">
            <div class="content-pad">
                <div class="mb-8 cursor-pointer text-gray-400 hover:text-black text-sm w-max" onclick="router.navigate('home')">
                    &larr; Back
                </div>
                
                <div class="flex justify-between items-baseline mb-12">
                    <h1 class="text-4xl font-extralight text-black" id="detail-title">--</h1>
                    <div class="text-xl font-light font-mono" id="detail-pnl">--</div>
                </div>
            </div>

            <div class="mb-12">
                <div class="h-[300px] w-full relative">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

            <div class="content-pad">
                <h3 class="text-xs uppercase text-gray-400 mb-4 tracking-widest">Active Orders</h3>
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Side</th>
                            <th>Size</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody id="detail-orders-body"></tbody>
                </table>
                <div id="detail-orders-empty" class="py-4 text-gray-400 text-sm font-mono hidden">No active orders.</div>
            </div>
        </div>

        <!-- BALANCE VIEW -->
        <div id="view-balance" class="view-section">
            <div class="content-pad mb-8 text-sm text-gray-400">Portfolio Value</div>
            <div class="h-[500px] w-full relative">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- LOG VIEW (History) -->
        <div id="view-log" class="view-section">
            <div class="content-pad">
                <div class="mb-8 text-sm text-gray-400">System Log (Order History)</div>
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Size</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body"></tbody>
                </table>
                <div id="log-empty" class="py-12 text-center text-gray-400 font-mono hidden">No events found.</div>
            </div>
        </div>

        <!-- CONTACT VIEW -->
        <div id="view-contact" class="view-section">
            <div class="flex flex-col items-center justify-center h-[60vh] content-pad">
                <div class="text-sm text-gray-400 mb-2">Contact</div>
                <div class="text-xl font-light font-mono border-b border-gray-200 pb-1" id="contact-email">
                    Loading...
                </div>
            </div>
        </div>

    </div>

    <script>
        const fmtUSD = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);

        // CONFIG: Stepped Lines + No Scales
        Chart.defaults.font.family = "'JetBrains Mono', monospace";
        Chart.defaults.font.size = 11;
        Chart.defaults.color = '#888';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
        Chart.defaults.plugins.tooltip.titleColor = '#000';
        Chart.defaults.plugins.tooltip.bodyColor = '#444';
        Chart.defaults.plugins.tooltip.borderColor = '#e5e5e5';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.displayColors = false; 
        
        const minimalChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 0 }, 
            interaction: { intersect: false, mode: 'index' },
            scales: {
                x: { 
                    type: 'time', 
                    time: { unit: 'minute' }, 
                    display: false, 
                    grid: { display: false },
                    offset: false,
                    bounds: 'data'
                },
                y: { 
                    display: true, 
                    grid: { 
                        display: false,
                        drawTicks: false
                    },
                    drawBorder: false, /* Removes the y-axis line */
                    offset: false,
                    ticks: {
                        maxTicksLimit: 11, 
                        crossAlign: 'near',
                        padding: 10
                    }
                }
            },
            plugins: { legend: { display: false } },
            elements: {
                point: { radius: 0, hitRadius: 40, hoverRadius: 4 }, 
                line: { borderWidth: 0 } /* Removes the data lines */
            }
        };

        const chartInstances = { home: null, balance: null, detail: null };

        function toggleMenu() {
            document.getElementById('menu-panel').classList.toggle('open');
            document.getElementById('menu-backdrop').classList.toggle('open');
        }

        const router = {
            navigate: (page, param = null) => {
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('active');
                    setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 150);
                });

                const target = document.getElementById(page === 'symbol' ? 'view-symbol' : `view-${page}`);
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);

                if (page === 'home') loadHomeData();
                if (page === 'balance') loadBalanceData();
                if (page === 'log') loadLogData();
                if (page === 'contact') loadContactData();
                if (page === 'symbol' && param) loadSymbolData(param);
            }
        };

        async function loadHomeData() {
            // Fallback mock data
            let chartData;
            try {
                const chartRes = await fetch('/api/symbols_chart');
                chartData = await chartRes.json();
            } catch (e) {
                chartData = {
                    'BTC': { invested: Array.from({length: 20}, (_, i) => ({x: Date.now()/1000 - (20-i)*3600, y: 30000 + Math.random()*1000})) },
                    'ETH': { invested: Array.from({length: 20}, (_, i) => ({x: Date.now()/1000 - (20-i)*3600, y: 2000 + Math.random()*100})) }
                };
            }
            
            const symbolsArray = Object.keys(chartData).map(sym => {
                const investedData = chartData[sym].invested || [];
                const lastVal = investedData.length > 0 ? investedData[investedData.length - 1].y : 0;
                return {
                    sym,
                    lastVal,
                    invested: investedData.map(pt => ({x: pt.x * 1000, y: pt.y}))
                };
            });
            // Sort by value (Descending), so large areas are drawn first (in the back)
            symbolsArray.sort((a, b) => b.lastVal - a.lastVal);

            const grid = document.getElementById('symbol-links-container');
            if (symbolsArray.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-300 text-sm font-mono">No data available</div>';
            } else {
                grid.innerHTML = symbolsArray.map(item => `
                    <div onclick="router.navigate('symbol', '${item.sym}')" 
                         class="text-center py-4 border border-transparent hover:border-gray-100 rounded cursor-pointer transition text-sm text-gray-600 hover:text-black">
                        <div class="font-medium">${item.sym}</div>
                    </div>
                `).join('');
            }

            const datasets = symbolsArray.map((item, idx) => {
                return {
                    label: item.sym,
                    data: item.invested,
                    borderColor: '#000000', 
                    borderWidth: 2,
                    stepped: true,
                    fill: 'start',      
                    backgroundColor: 'rgba(255, 255, 255, 1)' 
                };
            });

            if (chartInstances.home) chartInstances.home.destroy();
            chartInstances.home = new Chart(document.getElementById('homeChart'), {
                type: 'line',
                data: { datasets },
                options: minimalChartOptions
            });
        }

        async function loadBalanceData() {
            let points;
            try {
                const res = await fetch('/api/balance_history');
                const data = await res.json();
                points = data.map(d => ({ x: d.time * 1000, y: d.equity }));
            } catch (e) {
                points = Array.from({length: 20}, (_, i) => ({x: Date.now() - (20-i)*3600000, y: 50000 + i*100 + Math.random()*500}));
            }

            if (chartInstances.balance) chartInstances.balance.destroy();
            chartInstances.balance = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        data: points,
                        borderColor: '#000000',
                        borderWidth: 0,
                        fill: 'start',      
                        backgroundColor: 'rgba(255, 255, 255, 1)', 
                        stepped: true
                    }]
                },
                options: minimalChartOptions
            });
        }

        async function loadLogData() {
            let history = [];
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                history = data.history || [];
            } catch (e) {
                history = [];
            }
            
            const tbody = document.getElementById('log-table-body');
            
            if (history.length > 0) {
                tbody.innerHTML = history.map(item => {
                    // Backend now returns flat objects from the 'order_log' table
                    const time = item.timestamp * 1000;
                    const type = item.type || 'LIMIT';
                    const side = item.side ? item.side.toLowerCase() : '--';
                    const symbol = item.symbol || '--';
                    const size = item.size || '--';
                    const price = item.price || 'MKT';
                    
                    const sideClass = side === 'buy' ? 'text-green-700' : (side === 'sell' ? 'text-red-700' : 'text-gray-600');
                    
                    return `
                    <tr>
                        <td class="text-gray-500 text-xs font-mono">${new Date(time).toLocaleString()}</td>
                        <td>
                            <b>${symbol}</b>
                            <span class="text-xs text-gray-400 ml-1 uppercase border border-gray-100 px-1 rounded">${type}</span>
                        </td>
                        <td class="${sideClass} uppercase font-medium text-xs">${side}</td>
                        <td class="text-gray-700 font-mono">${size}</td>
                        <td class="text-gray-700 font-mono text-xs">${price !== 'MKT' ? '$' + price : price}</td>
                    </tr>
                `;
                }).join('');
                document.getElementById('log-empty').classList.add('hidden');
            } else {
                tbody.innerHTML = '';
                document.getElementById('log-empty').classList.remove('hidden');
                document.getElementById('log-empty').innerText = "No history found.";
            }
        }

        async function loadSymbolData(symbol) {
            document.getElementById('detail-title').innerText = symbol;
            
            let history = [];
            let orders = [];
            
            try {
                const detailRes = await fetch(`/api/symbol_detail/${symbol}`);
                const detail = await detailRes.json();
                history = detail.pnl_history || [];
                orders = detail.orders || [];
            } catch (e) {
                history = Array.from({length: 10}, (_, i) => ({x: Date.now()/1000 - i*3600, y: Math.random() * 100 - 50}));
            }
            
            const lastPnlValue = history.length > 0 ? history[history.length - 1].y : 0;
            const pnlEl = document.getElementById('detail-pnl');
            pnlEl.innerText = (lastPnlValue >= 0 ? '+' : '') + fmtUSD(lastPnlValue);
            pnlEl.style.color = lastPnlValue >= 0 ? '#1a1a1a' : '#000000'; 

            if (chartInstances.detail) chartInstances.detail.destroy();
            chartInstances.detail = new Chart(document.getElementById('detailChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        data: history.map(d => ({ x: d.x * 1000, y: d.y })),
                        borderColor: '#000000',
                        borderWidth: 0,
                        fill: 'start',
                        backgroundColor: 'rgba(255, 255, 255, 1)', 
                        stepped: true
                    }]
                },
                options: minimalChartOptions
            });

            const ordBody = document.getElementById('detail-orders-body');
            // Here we continue to show only ACTIVE (Open) Orders, 
            // as this makes the most sense for a symbol detail view.
            // The complete history is in the Log.
            if (orders.length > 0) {
                ordBody.innerHTML = orders.map(o => `
                    <tr>
                        <td class="uppercase text-xs tracking-wider">${o.orderType}</td>
                        <td class="${o.side === 'buy' ? 'text-green-700' : 'text-red-700'}">${o.side}</td>
                        <td class="font-mono">${o.unfilledSize}</td>
                        <td class="font-mono">$${o.limitPrice || o.stopPrice || 'MKT'}</td>
                    </tr>
                `).join('');
                document.getElementById('detail-orders-empty').classList.add('hidden');
            } else {
                ordBody.innerHTML = '';
                document.getElementById('detail-orders-empty').classList.remove('hidden');
            }
        }

        async function loadContactData() {
            try {
                const res = await fetch('/api/contact');
                const data = await res.json();
                document.getElementById('contact-email').innerText = data.email || "Loading failed";
            } catch (e) {
                document.getElementById('contact-email').innerText = "contact@primate.obs";
            }
        }

        router.navigate('home');
    </script>
</body>
</html>

