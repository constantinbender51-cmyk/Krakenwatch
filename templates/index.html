<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primate | Observatory</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden; /* No scrolling on main body */
        }
        
        /* Background Logo */
        .bg-logo {
            position: absolute;
            top: 50%; left: 62.5%; /* Center of the right 75% area */
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background-image: url('https://i.postimg.cc/QxYJKvBy/1767741251392.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.15; /* 50% usually interferes too much with charts, tuned to 15% for readability, or strictly 0.5 if requested */
            opacity: 0.5; 
            pointer-events: none;
            z-index: 0;
        }

        .chart-container {
            position: relative;
            z-index: 10;
        }

        /* Sidebar Item */
        .asset-item {
            cursor: pointer;
            padding: 8px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            transition: opacity 0.2s;
            opacity: 0.4;
        }
        .asset-item:hover { opacity: 0.8; }
        .asset-item.active { opacity: 1; font-weight: 600; }

        /* Color Mapping Classes will be applied via JS styles */
        
        /* Time Labels */
        .time-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            opacity: 0.2;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="flex">

    <div class="bg-logo"></div>

    <div class="w-1/4 h-full flex flex-col justify-between p-8 border-r border-black z-20 bg-white/90 backdrop-blur-sm">
        <div>
            <div class="mb-8 font-mono text-xs text-gray-400">ASSETS</div>
            <div id="asset-list" class="flex flex-col gap-2 h-[70vh] overflow-y-auto no-scrollbar">
                <div class="text-sm text-gray-400">Loading...</div>
            </div>
        </div>
        
        <div>
            <button onclick="showContact()" class="text-lg font-light hover:underline">contact</button>
            <div id="contact-info" class="text-sm font-mono mt-2 hidden text-gray-500">...</div>
        </div>
    </div>

    <div class="w-3/4 h-full flex flex-col relative z-10">
        
        <div class="h-1/2 w-full border-b border-black relative p-6">
            <div class="time-label top-10">1M</div>
            <div class="h-full w-full">
                <canvas id="topChart"></canvas>
            </div>
        </div>

        <div class="h-1/2 w-full relative p-6">
            <div class="time-label top-10">1d</div>
            <div class="h-full w-full">
                <canvas id="bottomChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // Specific asset colors as requested: 
        // "blue, green, brown, red, yellow, light blue, light green, light red, light yellow, pink"
        const colors = [
            '#2563eb', // Blue
            '#16a34a', // Green
            '#854d0e', // Brown
            '#dc2626', // Red
            '#ca8a04', // Yellow
            '#60a5fa', // Light Blue
            '#4ade80', // Light Green
            '#f87171', // Light Red
            '#fde047', // Light Yellow
            '#f472b6'  // Pink
        ];

        let chartInstances = { top: null, bottom: null };
        let activeSymbol = 'composite'; // 'composite' or symbol string

        // Chart.js Globals
        Chart.defaults.font.family = "'JetBrains Mono', monospace";
        Chart.defaults.color = '#1a1a1a';
        
        // --- LOGIC ---

        async function init() {
            try {
                const res = await fetch('/api/init');
                const data = await res.json();
                renderSidebar(data.symbols);
                loadData('composite'); // Load default view
            } catch (e) {
                console.error(e);
            }
        }

        function renderSidebar(symbols) {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';

            // Add "Composite" option implied as default state (or just resetting)
            const resetDiv = document.createElement('div');
            resetDiv.className = `asset-item ${activeSymbol === 'composite' ? 'active' : ''}`;
            resetDiv.innerText = "PORTFOLIO";
            resetDiv.onclick = () => { selectAsset('composite'); };
            container.appendChild(resetDiv);

            symbols.forEach((sym, idx) => {
                const el = document.createElement('div');
                el.className = `asset-item ${activeSymbol === sym ? 'active' : ''}`;
                el.innerText = sym;
                
                // Store color index for retrieval
                el.dataset.colorIndex = idx % colors.length;
                el.style.color = colors[idx % colors.length];
                
                el.onclick = () => { selectAsset(sym, idx); };
                container.appendChild(el);
            });
        }

        function selectAsset(symbol, colorIdx = -1) {
            activeSymbol = symbol;
            
            // Update sidebar visual state
            document.querySelectorAll('.asset-item').forEach(el => {
                el.classList.remove('active');
                if(el.innerText === symbol || (symbol === 'composite' && el.innerText === 'PORTFOLIO')) {
                    el.classList.add('active');
                }
            });

            const color = symbol === 'composite' ? '#000000' : colors[colorIdx % colors.length];
            loadData(symbol, color);
        }

        async function loadData(symbol, color = '#000000') {
            try {
                const res = await fetch(`/api/data/${symbol}`);
                const data = await res.json();
                
                renderTopChart(data.top, color, symbol === 'composite');
                renderBottomChart(data.bottom, color);
            } catch (e) {
                console.error("Failed to load chart data", e);
            }
        }

        function renderTopChart(dataPoints, color, isComposite) {
            const ctx = document.getElementById('topChart').getContext('2d');
            
            if (chartInstances.top) chartInstances.top.destroy();

            // Prepare Datasets
            const datasets = [{
                data: dataPoints,
                borderColor: color,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.1, // Slight curve, mostly jagged like sketch
                fill: false
            }];

            // If Composite, add the +5% and -5% lines
            if (isComposite) {
                // We simulate lines by adding datasets that span the x-axis range
                // Since X is time, this is tricky without Min/Max known. 
                // Using a plugin is cleaner, but here's a standard workaround:
                // We rely on the grid lines or we don't draw them as data, but as annotations if possible.
                // Simpler: Just rely on Chart.js grid configuration to highlight +5 and -5 ticks?
                // Or: Add a dataset with constant values.
                if (dataPoints.length > 0) {
                    const startX = dataPoints[0].x;
                    const endX = dataPoints[dataPoints.length-1].x;
                    
                    datasets.push({
                        data: [{x: startX, y: 5}, {x: endX, y: 5}],
                        borderColor: '#000000', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], label: '+5%'
                    });
                    datasets.push({
                        data: [{x: startX, y: -5}, {x: endX, y: -5}],
                        borderColor: '#000000', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], label: '-5%'
                    });
                }
            }

            chartInstances.top = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { display: false },
                            border: { display: false }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: (ctx) => (ctx.tick.value === 5 || ctx.tick.value === -5) && isComposite ? '#000000' : 'rgba(0,0,0,0.05)',
                                lineWidth: (ctx) => (ctx.tick.value === 5 || ctx.tick.value === -5) && isComposite ? 1 : 1
                            },
                            ticks: {
                                callback: function(value) { return value + '%' }
                            }
                        }
                    }
                }
            });
        }

        function renderBottomChart(dataPoints, color) {
            const ctx = document.getElementById('bottomChart').getContext('2d');
            
            if (chartInstances.bottom) chartInstances.bottom.destroy();

            // If no data (Composite view usually has no "size"), show empty or handle gracefully
            if (!dataPoints || dataPoints.length === 0) {
                 // Clear canvas if needed or show "Select asset"
                 return;
            }

            chartInstances.bottom = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        data: dataPoints.map(d => ({x: d.timestamp * 1000, y: d.qty})),
                        backgroundColor: color,
                        barThickness: 'flex',
                        maxBarThickness: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour' }, // 15m data, show hour ticks
                            grid: { display: false }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: (ctx) => ctx.tick.value === 0 ? '#000000' : 'rgba(0,0,0,0)',
                                lineWidth: 1
                            }
                        }
                    }
                }
            });
        }

        async function showContact() {
            try {
                const res = await fetch('/api/contact');
                const data = await res.json();
                const el = document.getElementById('contact-info');
                el.innerText = data.email;
                el.classList.remove('hidden');
            } catch(e) {}
        }

        // Init
        init();

    </script>
</body>
</html>
