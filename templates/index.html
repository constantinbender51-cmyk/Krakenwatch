<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primate | Observatory</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        medical: {
                            text: '#1a1a1a',
                            subtle: '#888888',
                            border: '#e5e5e5',
                            hover: '#f5f5f5'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #ffffff; color: #1a1a1a; font-family: 'Inter', sans-serif; }
        
        /* Clinical Minimalism */
        .page-container { max-width: 1000px; margin: 0 auto; padding: 120px 20px 40px 20px; }
        
        /* Typography */
        h1, h2, h3 { font-weight: 400; letter-spacing: -0.02em; }
        
        /* Brand Styling */
        .brand-text {
            font-weight: 100;
            font-size: 2.25rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: #1a1a1a;
        }
        
        /* Minimal Links */
        .clinical-link { 
            color: #1a1a1a; 
            text-decoration: none; 
            border-bottom: 1px solid #e5e5e5; 
            padding-bottom: 2px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .clinical-link:hover { border-bottom-color: #1a1a1a; }
        
        /* Minimal Table */
        .clean-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .clean-table th { text-align: left; font-weight: 500; color: #888; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
        .clean-table td { padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .clean-table tr:last-child td { border-bottom: none; }

        /* Menu Overlay */
        .menu-overlay {
            position: fixed; top: 0; right: 0; 
            width: 250px; height: 100vh; 
            background: white; border-left: 1px solid #e5e5e5;
            transform: translateX(100%); transition: transform 0.3s ease;
            z-index: 100; padding: 40px;
        }
        .menu-overlay.open { transform: translateX(0); }
        .menu-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(2px);
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 90;
        }
        .menu-backdrop.open { opacity: 1; pointer-events: auto; }
        
        /* Hidden classes for SPA */
        .view-section { display: none; opacity: 0; transition: opacity 0.3s; }
        .view-section.active { display: block; opacity: 1; }
    </style>
</head>
<body class="antialiased min-h-screen">

    <!-- Brand Header (Fixed Top Center) -->
    <div class="fixed top-8 left-1/2 transform -translate-x-1/2 z-50 cursor-pointer select-none" onclick="router.navigate('home')">
        <h1 class="brand-text">Primate</h1>
    </div>

    <!-- Subtle Menu Trigger (Top Right) -->
    <div class="fixed top-8 right-6 z-50 cursor-pointer p-2 hover:bg-gray-50 rounded-full" onclick="toggleMenu()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-black transition"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
    </div>

    <!-- Menu Overlay -->
    <div class="menu-backdrop" id="menu-backdrop" onclick="toggleMenu()"></div>
    <div class="menu-overlay" id="menu-panel">
        <div class="flex flex-col space-y-6 mt-12">
            <a onclick="router.navigate('home'); toggleMenu()" class="clinical-link">Home</a>
            <a onclick="router.navigate('balance'); toggleMenu()" class="clinical-link">Balance</a>
            <a onclick="router.navigate('log'); toggleMenu()" class="clinical-link">Log</a>
            <a onclick="router.navigate('contact'); toggleMenu()" class="clinical-link">Contact</a>
        </div>
    </div>

    <div class="page-container">

        <!-- VIEW: HOME (Main Page) -->
        <div id="view-home" class="view-section active">
            <!-- Chart Container -->
            <div class="mb-12">
                <div class="h-[400px] w-full relative">
                    <canvas id="homeChart"></canvas>
                </div>
            </div>

            <!-- Symbol Links -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6" id="symbol-links-container">
                <!-- Injected Links -->
                <div class="text-center text-gray-300 text-sm col-span-full">Loading assets...</div>
            </div>
        </div>

        <!-- VIEW: SYMBOL DETAIL -->
        <div id="view-symbol" class="view-section">
            <div class="mb-8 cursor-pointer text-gray-400 hover:text-black text-sm w-max" onclick="router.navigate('home')">
                &larr; Back
            </div>
            
            <div class="flex justify-between items-baseline mb-12">
                <h1 class="text-4xl font-light text-black" id="detail-title">--</h1>
                <div class="text-xl font-light" id="detail-pnl">--</div>
            </div>

            <div class="mb-12">
                <h3 class="text-xs uppercase text-gray-400 mb-4 tracking-widest">PnL Performance</h3>
                <div class="h-[300px] w-full relative">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

            <div>
                <h3 class="text-xs uppercase text-gray-400 mb-4 tracking-widest">Order History</h3>
                <table class="clean-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Side</th>
                            <th>Size</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody id="detail-orders-body"></tbody>
                </table>
                <div id="detail-orders-empty" class="py-4 text-gray-400 text-sm hidden">No active orders.</div>
            </div>
        </div>

        <!-- VIEW: BALANCE -->
        <div id="view-balance" class="view-section">
            <div class="mb-8 text-sm text-gray-400">Portfolio Value</div>
            <div class="h-[500px] w-full relative">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- VIEW: LOG -->
        <div id="view-log" class="view-section">
            <div class="mb-8 text-sm text-gray-400">System Log</div>
            <table class="clean-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Side</th>
                        <th>Size</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody id="log-table-body"></tbody>
            </table>
            <div id="log-empty" class="py-12 text-center text-gray-400 hidden">No events found.</div>
        </div>

        <!-- VIEW: CONTACT -->
        <div id="view-contact" class="view-section">
            <div class="flex flex-col items-center justify-center h-[60vh]">
                <div class="text-sm text-gray-400 mb-2">Contact</div>
                <div class="text-xl font-light border-b border-gray-200 pb-1" id="contact-email">
                    Loading...
                </div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        // --- Setup ---
        const fmtUSD = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);

        // Clinical Chart Defaults
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 11;
        Chart.defaults.color = '#888';
        Chart.defaults.scale.grid.color = '#f5f5f5';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
        Chart.defaults.plugins.tooltip.titleColor = '#000';
        Chart.defaults.plugins.tooltip.bodyColor = '#444';
        Chart.defaults.plugins.tooltip.borderColor = '#e5e5e5';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 10;
        
        const minimalChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
                x: { 
                    type: 'time', 
                    time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, 
                    grid: { display: false },
                    border: { display: false }
                },
                y: { 
                    grid: { color: '#f5f5f5', borderDash: [4, 4] },
                    border: { display: false },
                    position: 'right'
                }
            },
            plugins: { legend: { display: false } },
            elements: {
                point: { radius: 0, hitRadius: 20 },
                line: { borderWidth: 1.5 }
            }
        };

        const chartInstances = { home: null, balance: null, detail: null };

        // --- Router & UI ---
        function toggleMenu() {
            document.getElementById('menu-panel').classList.toggle('open');
            document.getElementById('menu-backdrop').classList.toggle('open');
        }

        const router = {
            navigate: (page, param = null) => {
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('active');
                    setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 300);
                });

                const target = document.getElementById(page === 'symbol' ? 'view-symbol' : `view-${page}`);
                target.style.display = 'block';
                // Small delay to allow display block to apply before opacity transition
                setTimeout(() => target.classList.add('active'), 10);

                if (page === 'home') loadHomeData();
                if (page === 'balance') loadBalanceData();
                if (page === 'log') loadLogData();
                if (page === 'contact') loadContactData();
                if (page === 'symbol' && param) loadSymbolData(param);
            }
        };

        // --- Data ---

        async function loadHomeData() {
            const chartRes = await fetch('/api/symbols_chart');
            const chartData = await chartRes.json();
            
            // Convert to array and sort by latest invested value
            const symbolsArray = Object.keys(chartData).map(sym => {
                const investedData = chartData[sym].invested || [];
                const lastVal = investedData.length > 0 ? investedData[investedData.length - 1].y : 0;
                return {
                    sym,
                    lastVal,
                    invested: investedData.map(pt => ({x: pt.x * 1000, y: pt.y}))
                };
            });

            // SORT: Highest position size first
            symbolsArray.sort((a, b) => b.lastVal - a.lastVal);

            // Render Links (Clean Grid)
            const grid = document.getElementById('symbol-links-container');
            if (symbolsArray.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-300 text-sm">No data available</div>';
            } else {
                grid.innerHTML = symbolsArray.map(item => `
                    <div onclick="router.navigate('symbol', '${item.sym}')" 
                         class="text-center py-4 border border-transparent hover:border-gray-100 rounded cursor-pointer transition text-sm text-gray-600 hover:text-black">
                        <div class="font-medium">${item.sym}</div>
                        <div class="text-xs text-gray-400 mt-1">${fmtUSD(item.lastVal)}</div>
                    </div>
                `).join('');
            }

            // Render Chart (Position Size USD)
            const datasets = symbolsArray.map((item, idx) => {
                return {
                    label: item.sym,
                    data: item.invested,
                    borderColor: `hsl(0, 0%, ${Math.max(0, idx * 10)}%)`, 
                    borderWidth: 1.5,
                    tension: 0
                };
            });

            if (chartInstances.home) chartInstances.home.destroy();
            chartInstances.home = new Chart(document.getElementById('homeChart'), {
                type: 'line',
                data: { datasets },
                options: minimalChartOptions
            });
        }

        async function loadBalanceData() {
            const res = await fetch('/api/balance_history');
            const data = await res.json();
            const points = data.map(d => ({ x: d.time * 1000, y: d.equity }));

            if (chartInstances.balance) chartInstances.balance.destroy();
            chartInstances.balance = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        data: points,
                        borderColor: '#1a1a1a',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0
                    }]
                },
                options: minimalChartOptions
            });
        }

        async function loadLogData() {
            const res = await fetch('/api/status');
            const data = await res.json();
            
            // Prefer history events if available, otherwise fall back to empty
            const history = data.history || [];
            
            const tbody = document.getElementById('log-table-body');
            
            if (history.length > 0) {
                tbody.innerHTML = history.map(item => {
                    const evt = item.event || {};
                    const order = item.order || {};
                    
                    const time = evt.timestamp || item.timestamp || Date.now();
                    const type = evt.type || 'EVENT';
                    const side = order.direction ? order.direction.toLowerCase() : (order.side || '--');
                    const symbol = order.symbol || '--';
                    const size = order.quantity || order.size || '--';
                    const price = order.limitPrice || order.price || 'MKT';
                    
                    const sideClass = side === 'buy' ? 'text-green-700' : (side === 'sell' ? 'text-red-700' : 'text-gray-600');
                    
                    return `
                    <tr>
                        <td class="text-gray-500 text-xs">${new Date(time).toLocaleString()}</td>
                        <td>
                            <b>${symbol}</b>
                            <span class="text-xs text-gray-400 ml-1 uppercase border border-gray-100 px-1 rounded">${type}</span>
                        </td>
                        <td class="${sideClass} uppercase font-medium text-xs">${side}</td>
                        <td class="text-gray-700">${size}</td>
                        <td class="text-gray-700 font-mono text-xs">${price !== 'MKT' ? '$' + price : price}</td>
                    </tr>
                `;
                }).join('');
                document.getElementById('log-empty').classList.add('hidden');
            } else {
                tbody.innerHTML = '';
                document.getElementById('log-empty').classList.remove('hidden');
                document.getElementById('log-empty').innerText = "No history found.";
            }
        }

        async function loadSymbolData(symbol) {
            document.getElementById('detail-title').innerText = symbol;
            
            // Get Current PnL
            const statusRes = await fetch('/api/status');
            const status = await statusRes.json();
            const pos = (status.positions || []).find(p => p.symbol === symbol);
            
            const pnlEl = document.getElementById('detail-pnl');
            if (pos) {
                let pnl = pos.pnl || 0;
                pnlEl.innerText = (pnl >= 0 ? '+' : '') + fmtUSD(pnl);
                pnlEl.style.color = pnl >= 0 ? '#1a1a1a' : '#ef4444';
            } else {
                pnlEl.innerText = 'Closed';
                pnlEl.style.color = '#888';
            }

            const detailRes = await fetch(`/api/symbol_detail/${symbol}`);
            const detail = await detailRes.json();

            if (chartInstances.detail) chartInstances.detail.destroy();
            chartInstances.detail = new Chart(document.getElementById('detailChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        data: detail.pnl_history.map(d => ({ x: d.x * 1000, y: d.y })),
                        borderColor: '#1a1a1a',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0
                    }]
                },
                options: minimalChartOptions
            });

            const ordBody = document.getElementById('detail-orders-body');
            ordBody.innerHTML = detail.orders.map(o => `
                <tr>
                    <td class="uppercase text-xs tracking-wider">${o.orderType}</td>
                    <td class="${o.side === 'buy' ? 'text-green-700' : 'text-red-700'}">${o.side}</td>
                    <td>${o.size}</td>
                    <td>$${o.limitPrice || o.stopPrice || 'MKT'}</td>
                </tr>
            `).join('');
            document.getElementById('detail-orders-empty').classList.toggle('hidden', detail.orders.length > 0);
        }

        async function loadContactData() {
            const res = await fetch('/api/contact');
            const data = await res.json();
            document.getElementById('contact-email').innerText = data.email || "";
        }

        // Initialize
        router.navigate('home');

    </script>
</body>
</html>

