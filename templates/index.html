<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primate | Observatory</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            height: 100vh; /* Ensure this is only in CSS */
            overflow: hidden;
        }
        
        /* Logo Centered Top 25% */
        .bg-logo {
            position: absolute;
            top: 25%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background-image: url('https://i.postimg.cc/QxYJKvBy/1767741251392.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar Item */
        .asset-item {
            cursor: pointer;
            padding: 6px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            transition: opacity 0.2s;
            opacity: 0.4;
            color: #000;
        }
        .asset-item:hover { opacity: 0.8; }
        .asset-item.active { opacity: 1; font-weight: 600; }

        /* Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Divider Control */
        #chart-divider {
            transition: opacity 0.2s;
        }

        /* Time Labels - Solid Black */
        .time-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            color: #000000;
            opacity: 1;
            font-weight: 500;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="flex">

    <div class="bg-logo"></div>

    <div class="w-1/4 h-full flex flex-col justify-between p-8 z-20 bg-transparent">
        <div>
            <div id="asset-list" class="flex flex-col gap-2 h-[70vh] overflow-y-auto no-scrollbar pt-12">
                <div class="text-sm text-gray-400">Loading...</div>
            </div>
        </div>
        
        <div>
            <button onclick="showContact()" class="text-lg font-light hover:underline">contact</button>
            <div id="contact-info" class="text-sm font-mono mt-2 hidden text-gray-500">...</div>
        </div>
    </div>

    <div class="w-3/4 h-full flex flex-col relative z-10">
        
        <div class="h-1/2 w-full relative p-6 flex flex-col justify-end">
            <div class="time-label top-10">1M</div>
            <div class="h-full w-full relative">
                <canvas id="topChart"></canvas>
            </div>
        </div>

        <div id="chart-divider" class="w-full border-b border-black opacity-0"></div>

        <div class="h-1/2 w-full relative p-6">
            <div class="time-label top-10">1d</div>
            <div class="h-full w-full">
                <canvas id="bottomChart"></canvas>
            </div>
        </div>

    </div>

    <script>
        const colors = [
            '#2563eb', '#16a34a', '#854d0e', '#dc2626', '#ca8a04', 
            '#60a5fa', '#4ade80', '#f87171', '#fde047', '#f472b6'
        ];

        let chartInstances = { top: null, bottom: null };
        let activeSymbol = 'composite';

        Chart.defaults.font.family = "'JetBrains Mono', monospace";
        Chart.defaults.color = '#1a1a1a';
        
        async function init() {
            try {
                const res = await fetch('/api/init');
                const data = await res.json();
                renderSidebar(data.symbols);
                loadData('composite');
            } catch (e) { console.error(e); }
        }

        function formatSymbolName(rawSym) {
            let s = rawSym.toUpperCase().replace('USD', '');
            if (s.startsWith('PF_')) s = s.replace('PF_', '');
            else if (s.startsWith('FF_') || s.startsWith('FI_')) s = s.replace('_', '');
            else s = s.replace('_', '');
            return s;
        }

        function renderSidebar(symbols) {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';

            const resetDiv = document.createElement('div');
            resetDiv.className = `asset-item ${activeSymbol === 'composite' ? 'active' : ''}`;
            resetDiv.innerText = "PORTFOLIO";
            resetDiv.onclick = () => { selectAsset('composite'); };
            container.appendChild(resetDiv);

            symbols.forEach((sym, idx) => {
                const el = document.createElement('div');
                el.className = `asset-item ${activeSymbol === sym ? 'active' : ''}`;
                el.innerText = formatSymbolName(sym);
                el.style.color = colors[idx % colors.length];
                el.onclick = () => { selectAsset(sym, idx); };
                container.appendChild(el);
            });
        }

        function selectAsset(symbol, colorIdx = -1) {
            activeSymbol = symbol;
            
            const divider = document.getElementById('chart-divider');
            if (symbol === 'composite') {
                divider.classList.add('opacity-0');
            } else {
                divider.classList.remove('opacity-0');
            }
            
            document.querySelectorAll('.asset-item').forEach(el => {
                const isPortfolio = symbol === 'composite' && el.innerText === 'PORTFOLIO';
                if(isPortfolio || (symbol !== 'composite' && el.innerText === formatSymbolName(symbol))) {
                    el.classList.add('active');
                    el.style.opacity = '1';
                } else {
                    el.classList.remove('active');
                    el.style.opacity = '0.4';
                }
            });

            const color = symbol === 'composite' ? '#000000' : colors[colorIdx % colors.length];
            loadData(symbol, color);
        }

        async function loadData(symbol, color = '#000000') {
            try {
                const res = await fetch(`/api/data/${symbol}`);
                const data = await res.json();
                renderTopChart(data.top, color, symbol === 'composite');
                renderBottomChart(data.bottom, color);
            } catch (e) { console.error(e); }
        }

        function renderTopChart(dataPoints, color, isComposite) {
            const ctx = document.getElementById('topChart').getContext('2d');
            if (chartInstances.top) chartInstances.top.destroy();

            const datasets = [{
                data: dataPoints,
                borderColor: color,
                borderWidth: 4, 
                pointRadius: 0,
                tension: 0.1,
                fill: false
            }];

            if (isComposite && dataPoints.length > 0) {
                const startX = dataPoints[0].x;
                const endX = dataPoints[dataPoints.length-1].x;
                const lineStyle = {
                    borderColor: '#000000', borderWidth: 2, pointRadius: 0, borderDash: [] 
                };
                datasets.push({ ...lineStyle, data: [{x: startX, y: 5}, {x: endX, y: 5}] });
                datasets.push({ ...lineStyle, data: [{x: startX, y: -5}, {x: endX, y: -5}] });
            }

            chartInstances.top = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }, 
                    scales: {
                        x: { display: false }, 
                        y: { display: false }
                    },
                    layout: { padding: 0 }
                }
            });
        }

        function renderBottomChart(dataPoints, color) {
            const ctx = document.getElementById('bottomChart').getContext('2d');
            if (chartInstances.bottom) chartInstances.bottom.destroy();

            if (!dataPoints || dataPoints.length === 0) return;

            chartInstances.bottom = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        data: dataPoints.map(d => ({x: d.timestamp * 1000, y: d.qty})),
                        backgroundColor: '#93c5fd', // Fixed Light Blue
                        barThickness: 'flex',
                        maxBarThickness: 2 // Thin lines
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false }, 
                        y: {
                            display: true, 
                            drawBorder: false, 
                            ticks: { display: false }, 
                            grid: {
                                color: (ctx) => ctx.tick.value === 0 ? '#000000' : 'transparent',
                                lineWidth: 2,
                                drawBorder: false,
                                drawTicks: false
                            }
                        }
                    },
                    layout: { padding: 0 }
                }
            });
        }

        async function showContact() {
            try {
                const res = await fetch('/api/contact');
                const data = await res.json();
                const el = document.getElementById('contact-info');
                el.innerText = data.email;
                el.classList.remove('hidden');
            } catch(e) {}
        }

        init();
    </script>
</body>
</html>
